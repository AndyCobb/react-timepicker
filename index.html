<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap-timepicker.css">
  </head>
  <body>
    <div id="main"></div>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="bootstrap-timepicker.js"></script>
    <script src="http://fb.me/react-with-addons-0.11.2.js"></script>
    <script src="http://fb.me/JSXTransformer-0.11.2.js"></script>
    <script>
      // Object.assign polyfill from https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign
      if (!Object.assign) {
        Object.defineProperty(Object, "assign", {
          enumerable: false,
          configurable: true,
          writable: true,
          value: function(target, firstSource) {
            "use strict";
            if (target === undefined || target === null)
              throw new TypeError("Cannot convert first argument to object");

            var to = Object(target);

            var hasPendingException = false;
            var pendingException;

            for (var i = 1; i < arguments.length; i++) {
              var nextSource = arguments[i];
              if (nextSource === undefined || nextSource === null)
                continue;

              var keysArray = Object.keys(Object(nextSource));
              for (var nextIndex = 0, len = keysArray.length; nextIndex < len; nextIndex++) {
                var nextKey = keysArray[nextIndex];
                try {
                  var desc = Object.getOwnPropertyDescriptor(nextSource, nextKey);
                  if (desc !== undefined && desc.enumerable)
                    to[nextKey] = nextSource[nextKey];
                } catch (e) {
                  if (!hasPendingException) {
                    hasPendingException = true;
                    pendingException = e;
                  }
                }
              }

              if (hasPendingException)
                throw pendingException;
            }
            return to;
          }
        });
      }
    </script>
    <script type="text/jsx">
      /** @jsx React.DOM */

      // TODO: Should a prop change overwrite the current value?
      var AutoField = React.createClass({
        getInitialState: function() {
          return {
            currentValue: this.props.value,
            focused:      false
          };
        },

        componentWillReceiveProps: function(nextProps) {
          console.log('willReceiveProps', nextProps);
          console.log('state', this.state);
          if (!this.state.focused) {
            this.setState({
              currentValue: nextProps.value
            });
          }
        },

        handleChange: function(e) {
          this.setState({
            currentValue: e.target.value
          });
        },

        handleKeyUp: function(e) {
          if (e.keyCode === 13) {
            this.getDOMNode().blur();
            this.handleBlur();
          }
        },

        handleFocus: function() {
          this.setState({
            focused: true
          });
        },

        handleBlur: function() {
          var currentValue = this.state.currentValue;

          this.setState({
            currentValue: this.props.value,
            focused:      false
          });

          if (this.props.onChange) {
            this.props.onChange({ value: currentValue });
          }
        },

        render: function() {
          return <input {...this.props} onChange={this.handleChange} value={this.state.currentValue} onBlur={this.handleBlur} onKeyUp={this.handleKeyUp}/>;
        }
      });

      // TODO: Decrement minute with 12:00 AM doesn't work.
      var TimePicker = React.createClass({
        statics: {
          fromDate: function(d) {
            var h   = d.getHours(),
                m   = d.getMinutes();

            return TimePicker.stringify({
              hour: h % 12,
              minute: m,
              meridian: h > 12 ? 'PM' : 'AM'
            });
          },

          toMinutes: function(d) {
            var hour = d.hour % 12,
                minute = d.minute,
                meridian = d.meridian;

            return hour*60 + minute + (meridian === 'PM' ? 12*60 : 0);
          },

          fromMinutes: function(m) {
            var hour, minute, meridian;

            m = m % (24*60);

            if (m >= 12*60) {
              m        -= 12*60;
              meridian  = 'PM';
            } else {
              meridian = 'AM';
            }

            hour   = (m / 60)|0;
            minute = m % 60;

            if (hour === 0) {
              hour = 12;
            }

            return {hour: hour, minute: minute, meridian: meridian};
          },

          stringify: function(d) {
            var m = d.minute;

            if (m < 10) {
              m = '0' + m;
            }

            return d.hour + ':' + m + ' ' + d.meridian;
          },

          parse: function(s) {
            var parsed = s.match(/(\d+):(\d+)\s*(\w+)?/);

            if (parsed) {
              var hour     = +parsed[1],
                  minute   = +parsed[2],
                  meridian = parsed[3];

              if (isNaN(hour))   hour   = 12;
              if (isNaN(minute)) minute = 0;
              if (hour > 12)     hour   = 12;
              if (minute > 59)   minute = 59;
              
              switch (meridian && meridian.toLowerCase()) {
              default:
              case 'am':
                meridian = 'AM';
              break;
              case 'pm':
                meridian = 'PM';
              break;
              }

              return {
                hour: hour,
                minute: minute,
                meridian: meridian
              };
            }

            return null;
          }
        },

        getInitialState: function() {
          return {
            showModal: false
          };
        },

        handleChange: function(e) {
          var parsed = TimePicker.parse(e.value);

          if (parsed) {
            this.props.onChange({ value: TimePicker.stringify(parsed) });
          }
        },

        normalize: function(s) {
          var parsed = TimePicker.parse(s);

          return parsed && TimePicker.stringify(parsed);
        },

        toggleModal: function() {
          this.setState({
            showModal: !this.state.showModal
          });
        },

        renderModal: function() {
          if (this.state.showModal) {
            var input   = this.refs.timepicker.getDOMNode(),
                x       = input.offsetLeft,
                y       = input.offsetTop + input.offsetHeight,
                parsed  = TimePicker.parse(this.props.value),
                minutes = TimePicker.toMinutes(parsed);

            var tdstyle = {'text-align': 'center', 'vertical-align': 'middle'};

            var change = function(amount) {
              return function() {
                if (this.props.onChange) {
                  this.props.onChange({ value: TimePicker.stringify(TimePicker.fromMinutes(minutes + amount)) });
                }
              }.bind(this);
            }.bind(this);

            var changeHour = function(e) {
              this.props.onChange({ value: TimePicker.stringify({ hour: e.target.value, minute: parsed.minute, meridian: parsed.meridian }) });
            }.bind(this);
            var changeMinute = function(e) {
              this.props.onChange({ value: TimePicker.stringify({ hour: parsed.hour, minute: e.target.value, meridian: parsed.meridian }) });
            }.bind(this);
            var changeMeridian = function(e) {
              this.props.onChange({ value: TimePicker.stringify({ hour: parsed.hour, minute: parsed.minute, meridian: e.target.value }) });
            }.bind(this);

            return <div style={{left: x, top: y, position: 'absolute', display: 'block', padding: 5}} className="dropdown-menu">
              <table>
                <tr>
                  <td style={tdstyle} onClick={change(+60)}><i className="glyphicon glyphicon-chevron-up"/></td>
                  <td/>
                  <td style={tdstyle} onClick={change(+1)}><i className="glyphicon glyphicon-chevron-up"/></td>
                  <td/>
                  <td style={tdstyle} onClick={change(+12*60)}><i className="glyphicon glyphicon-chevron-up"/></td>
                </tr>
                <tr>
                  <td><input className="form-control" style={{width: 45, 'text-align': 'right'}} type="text" value={parsed.hour} onChange={changeHour}/></td>
                  <td style={{padding: 10, 'text-align': 'center'}}>:</td>
                  <td><input className="form-control" style={{width: 45, 'text-align': 'right'}} type="text" value={('0' + parsed.minute).slice(-2)} onChange={changeMinute}/></td>
                  <td style={{padding: 10}}></td>
                  <td><input className="form-control" size="2" type="text" value={parsed.meridian} onChange={changeMeridian}/></td>
                </tr>
                <tr>
                  <td style={tdstyle} onClick={change(-60)}><i className="glyphicon glyphicon-chevron-down"/></td>
                  <td/>
                  <td style={tdstyle} onClick={change(-1)}><i className="glyphicon glyphicon-chevron-down"/></td>
                  <td/>
                  <td style={tdstyle} onClick={change(-12*60)}><i className="glyphicon glyphicon-chevron-down"/></td>
                </tr>
              </table>
            </div>;
          }
        },

        render: function() {
          console.log('current value', this.props.value);
          return <div>
            <div className="input-group" style={{width: 150}}>
              <AutoField ref="timepicker" type="text" onChange={this.handleChange} value={this.props.value} normalize={this.normalize} className="form-control"/>
              <span className="input-group-btn">
                <button className="btn btn-default" type="button" onClick={this.toggleModal}><i className="glyphicon glyphicon-time"/></button>
              </span>
            </div>
            {this.renderModal()}
          </div>;
        }
      });

      var Main = React.createClass({
        getInitialState: function() {
          return {
            time: TimePicker.fromDate(new Date)
          };
        },

        handleTimeChange: function(e) {
          this.setState({
            time: e.value
          });
        },

        render: function() {
          return <div>
            <TimePicker value={this.state.time} onChange={this.handleTimeChange}/>
          </div>;
        }
      });

      React.renderComponent(<Main/>, document.getElementById('main'));
    </script>
  </body>
</html>
